{"name":"Generate Currency for Selected Tokens (Customizable)","permission":{"default":0,"LqsOjvGNORiotzcI":3},"type":"script","flags":{"core":{"sourceId":"Macro.RZ3ozq4O3xgvRFYJ"}},"scope":"global","command":"function generateCurrencyForSelectedTokens() {\n  new Dialog({\n    title: 'Currency Generator',\n    content: `Generate currency for all selected tokens?`,\n    buttons: {\n      no: {\n        icon: '<i class=\"fas fa-ban\"></i>',\n        label: 'Cancel',\n      },\n      yes: {\n        icon: '<i class=\"fas fa-thumbs-up\"></i>',\n        label: 'Generate',\n        callback: (html) => {\n          if (canvas.tokens.controlled.length == 0) {\n            ui.notifications.error(\n              'Tokens must be selected to generate currency'\n            );\n            return;\n          }\n\n          const filtered = canvas.tokens.controlled.filter((token) => {\n            if (token.actor.hasPlayerOwner) {\n              ui.notifications.warn(\n                `Cannot modify player owned token ${token.name}`\n              );\n              return false;\n            }\n\n            if (token.actor.data.token.actorLink) {\n              ui.notifications.warn(`Cannot modify linked token ${token.name}`);\n              return false;\n            }\n\n            if (token.actor.data.type != 'npc') {\n              ui.notifications.warn(\n                `Cannot modify non-NPC token ${token.name}`\n              );\n              return false;\n            }\n            return true;\n          });\n          filtered.forEach(async (token) => {\n            const actor = game.actors.get(token.data.actorId);\n\n            const pocketChange = new game.dfreds.PocketChange();\n            const currency = pocketChange.generateCurrency(actor);\n            let newCurrencyData = {};\n            newCurrencyData['data.currency'] = currency;\n\n            await token.actor.update(newCurrencyData);\n          });\n          ui.notifications.info(\n            `Generated currency for ${filtered.length} tokens`\n          );\n        },\n      },\n    },\n    default: 'no',\n  }).render(true);\n}\n\ngenerateCurrencyForSelectedTokens();","author":"LqsOjvGNORiotzcI","img":"icons/commodities/currency/coins-assorted-mix-copper-silver-gold.webp","actorIds":[],"_id":"HfojCT525Pd19cwo"}
{"name":"Convert Selected Tokens to Loot (Customizable)","permission":{"default":0,"LqsOjvGNORiotzcI":3},"type":"script","flags":{"furnace":{"runAsGM":false},"core":{"sourceId":"Macro.mnQeZ47SDbSZ9jvn"}},"scope":"global","command":"function convertSelectedTokensToLoot() {\n  new Dialog({\n    title: 'Loot Converter',\n    content: `Convert all selected tokens to loot?`,\n    buttons: {\n      no: {\n        icon: '<i class=\"fas fa-ban\"></i>',\n        label: 'Cancel',\n      },\n      yes: {\n        icon: '<i class=\"fas fa-thumbs-up\"></i>',\n        label: 'Convert',\n        callback: (html) => {\n          if (canvas.tokens.controlled.length == 0) {\n            ui.notifications.error(\n              'Tokens must be selected to convert to loot'\n            );\n            return;\n          }\n\n          const filtered = canvas.tokens.controlled.filter((token) => {\n            if (token.actor.hasPlayerOwner) {\n              ui.notifications.warn(\n                `Cannot modify player owned token ${token.name}`\n              );\n              return false;\n            }\n\n            if (token.actor.data.token.actorLink) {\n              ui.notifications.warn(`Cannot modify linked token ${token.name}`);\n              return false;\n            }\n\n            if (token.actor.data.type != 'npc') {\n              ui.notifications.warn(\n                `Cannot modify non-NPC token ${token.name}`\n              );\n              return false;\n            }\n\n            return true;\n          });\n          filtered.forEach(async (token) => {\n            // Remove natural weapons, natural armor, class features, spells, and feats.\n            let newItems = token.actor.data.items\n              .filter((item) => {\n                if (item.type == 'weapon') {\n                  return item.data.weaponType != 'natural';\n                }\n                if (item.type == 'equipment') {\n                  if (!item.data.armor) return true;\n                  return item.data.armor.type != 'natural';\n                }\n                return !['class', 'spell', 'feat'].includes(item.type);\n              })\n              .map((item) => {\n                item.data.equipped = false;\n                return item;\n              });\n\n            await token.actor.update({ items: newItems });\n\n            let newActorData = {\n              flags: {\n                core: {\n                  sheetClass: 'dnd5e.LootSheet5eNPC',\n                },\n                lootsheetnpc5e: {\n                  lootsheettype: 'Loot',\n                },\n              },\n            };\n\n            // Handles if they already have currency set somehow\n            if (typeof token.actor.data.data.currency.cp === 'number') {\n              let oldCurrencyData = token.actor.data.data.currency;\n              newActorData['data.currency'] = {\n                cp: { value: oldCurrencyData.cp },\n                ep: { value: oldCurrencyData.ep },\n                gp: { value: oldCurrencyData.gp },\n                pp: { value: oldCurrencyData.pp },\n                sp: { value: oldCurrencyData.sp },\n              };\n            }\n            await token.actor.update(newActorData);\n\n            if (game.modules.get('combat-utility-belt')?.active) {\n              await game.cub.removeAllConditions(token);\n            }\n\n            let lootingUsers = game.users.entries.filter((user) => {\n              return (\n                user.role == USER_ROLES.PLAYER ||\n                user.role == USER_ROLES.TRUSTED\n              );\n            });\n            let permissions = {};\n            Object.assign(permissions, token.actor.data.permission);\n            lootingUsers.forEach((user) => {\n              permissions[user.data._id] = ENTITY_PERMISSIONS.OBSERVER;\n            });\n\n            await token.update({\n              overlayEffect: 'icons/svg/chest.svg',\n              // effects: ['icons/containers/bags/pouch-simple-brown.webp'],\n              actorData: {\n                actor: {\n                  flags: {\n                    loot: {\n                      playersPermission: ENTITY_PERMISSIONS.OBSERVER,\n                    },\n                  },\n                },\n                permission: permissions,\n              },\n            });\n          });\n          ui.notifications.info(`Converted ${filtered.length} tokens to loot`);\n        },\n      },\n    },\n    default: 'no',\n  }).render(true);\n}\n\nconvertSelectedTokensToLoot();","author":"LqsOjvGNORiotzcI","img":"icons/containers/bags/coinpouch-simple-leather-silver-brown.webp","actorIds":[],"_id":"PQczjKHVW6PFGcfr"}
{"name":"Convert Selected Tokens to Loot","permission":{"default":0,"LqsOjvGNORiotzcI":3},"type":"script","flags":{"core":{"sourceId":"Macro.uXaOY2ziotAvxdrg"}},"scope":"global","command":"const macroSupport = new game.dfreds.MacroSupport();\nmacroSupport.convertSelectedTokensToLoot();","author":"LqsOjvGNORiotzcI","img":"icons/containers/bags/coinpouch-simple-leather-silver-brown.webp","actorIds":[],"_id":"hLgNNTD0QkC3ReSM"}
{"name":"Generate Currency for Selected Tokens","permission":{"default":0,"LqsOjvGNORiotzcI":3},"type":"script","flags":{"core":{"sourceId":"Macro.R9w15lFmGsAIHCQK"}},"scope":"global","command":"const macroSupport = new game.dfreds.MacroSupport();\nmacroSupport.generateCurrencyForSelectedTokens();","author":"LqsOjvGNORiotzcI","img":"icons/commodities/currency/coins-assorted-mix-copper-silver-gold.webp","actorIds":[],"_id":"luHeGvrjMKrovtsK"}
{"name":"Generate Currency and Convert to Loot for Selected Tokens","permission":{"default":0,"LqsOjvGNORiotzcI":3},"type":"script","flags":{"core":{"sourceId":"Macro.AeNaDDCdrTvBlqNJ"}},"scope":"global","command":"const macroSupport = new game.dfreds.MacroSupport();\nmacroSupport.generateCurrencyAndConvertToLootForSelectedTokens();","author":"LqsOjvGNORiotzcI","img":"icons/containers/bags/coinpouch-gold-red.webp","actorIds":[],"_id":"syQHfOfeUzlvYDGQ"}
